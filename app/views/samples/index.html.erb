<h2>Samples</h2>

<% content_for :js do %>
jQuery(function() {
    var $ = jQuery.noConflict();
    $(document).ready(function() {
        $("noscript").remove();
        $("#samples").removeClass('admin_table');
        $('#samples').dataTable( {
            "bProcessing": true,
            "bServerSide": true,
            "bJQueryUI": true,
            "sAjaxSource": '<%=j(samples_path)%>',
            "aoColumns": [
                { 'mDataProp': 'crc_id',
                  'fnRender': function(oObj) {
                      var r = '' + oObj.aData.crc_id;
                      if(oObj.aData.id)
                          r = '<a href="/samples/'+oObj.aData.id+'">'+r+'</a>';
                      if (oObj.aData.url_code)
                          r += ' (' + oObj.aData.url_code + ')';
                      return r;
                  }
                },
                { 'mDataProp': 'study.name' },
                { 'mDataProp': 'kit.name' },
                { 'mDataProp': 'participant.hex',
                  'fnRender': function(oObj) {
                      if (!oObj.aData.participant ||
                          !oObj.aData.participant.hex)
                          return '';
                      return '<a href="/profile/'+oObj.aData.participant.hex+'">'+oObj.aData.participant.hex+'</a>';
                  }
                },
                { 'mDataProp': 'qc_result.QC Status',
                  'asSorting': ['desc','asc']
                },
                { 'mDataProp': 'owner.display_name',
                  'bSortable': false,
                  'fnRender': function(oObj) {
                      if (!oObj.aData.owner)
                          return '';
                      if (oObj.aData.owner.hex)
			  return '<a href="/profile/'+oObj.aData.owner.hex+'">'+oObj.aData.owner.hex+'</a>';
                      else
                          return oObj.aData.owner.full_name;
                  }
                },
                { 'mDataProp': 'log_url',
                  'bSortable': false,
                  'fnRender': function(oObj) {
                      if(!oObj.aData.id)
                          return null;
                      return '&nbsp;<a href="/samples/'+oObj.aData.id+'/log">log</a>&nbsp;';
                  } },
                { 'mDataProp': 'edit_url',
                  'bSortable': false,
                  'fnRender': function(oObj) {
                      if(!oObj.aData.id)
                          return null;
                      return '&nbsp;<a href="/samples/'+oObj.aData.id+'/edit">edit</a>&nbsp;';
                  } },
                { 'mDataProp': 'delete_url',
                  'bSortable': false,
                  'fnRender': function(oObj) {
                      if(!oObj.aData.id || oObj.aData.last_mailed)
                          return null;
                      return '&nbsp;<a href="/samples/'+oObj.aData.id+'/delete">delete</a>&nbsp;';
                  } } ]
            } ).
            fnSetFilteringDelay().
            fnSkipMissingDataProps();
    } );
});
<% end %>
<% content_for :head do %>
  <%= javascript_include_tag 'jquery.dataTables.fnSetFilteringDelay' %>
  <%= javascript_include_tag 'jquery.dataTables.fnSkipMissingDataProps' %>
  <%= javascript_include_tag 'jquery.dataTables.renderers' %>
<% end %>

<% if current_user.is_admin? %>
<p>Because you are an administrator, this page lists all samples by any researcher.</p>
<% else %>
<p>Listed below are the samples in your possession.</p>
<% end %>

<p>
  <%= link_to 'Enter IDs of received samples here', receive_sample_path %>
  when you receive samples from a participant or researcher.
</p>

<noscript><%= will_paginate @samples %></noscript>
<table id="samples" style="width: 100%" class="admin_table">
  <thead>
    <tr>
      <th width="15%">Number</th>
      <th width="35%">Study</th>
      <th width="10%">Kit</th>
      <th width="10%">Participant</th>
      <th width="8%">QC</th>
      <th width="12%">Owner</th>
      <th width="5%">&nbsp;</th>
      <th width="5%">&nbsp;</th>
      <th width="5%">&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <noscript>
      <% @samples.each do |sample| %>
      <tr>
	<td><%= link_to sample.crc_id_s, sample %></td>
	<td><%= sample.study.name %></td>
	<td><%= sample.kit.name if sample.kit %></td>
	<td><%= sample.participant.nil? ? '' : link_to(sample.participant.hex, public_profile_path(sample.participant.hex)) %></td>
	<td>
	  <% if sample.owner.nil? %>
	  <% elsif sample.owner.is_researcher? %>
	  <%= sample.owner.full_name %>
	  <% else %>
	  <%= sample.owner.hex %>
	  <% end %>
	</td>
        <td><%= sample.qc_result ? 'Y' : '' %></td>
	<td><%= link_to 'Log', show_sample_log_path(sample), :class => "iframe", :title => "Sample log for #{sample.name} (#{sample.kit ? sample.kit.name :: 'no'} kit)" %></td>
	<td><%= link_to 'Edit', edit_sample_path(sample) %></td>
	<td><%= sample.last_mailed.nil? ? link_to('Delete', sample, :confirm => 'Are you sure?', :method => :delete) : '' %></td>
      </tr>
      <% end %>
    </noscript>
  </tbody>
</table>
<noscript><%= will_paginate @samples %></noscript>
