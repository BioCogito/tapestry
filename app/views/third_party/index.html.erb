<% content_for :head do %>
  <%= javascript_include_tag 'third_party' %>
<% end %>

<h2>Third party activities</h2>

<p>The following activities are not conducted or supervised by the
Personal Genome Project, but we think you might be interested in
learning about them.</p>

<p><i>Activities posted on this page are not approved or reviewed by
the Harvard Medical School Institutional Review Board.</i></p>

<ul>
  <% @studies.each do |study| %>
    <li><%= link_to study.name, third_party_study_path(study) %> (<%= study.researcher.full_name %>, <%= study.researcher.researcher_affiliation %>)</li>
  <% end %>
</ul>

<% if defined? @open_humans_services && @open_humans_services.any? %>
  <h3>Open Humans Project</h3>

  <ul>
    <% @open_humans_services.each do |service| %>
      <li>
        <%= service.name %>
        <% user_token = service.oauth_tokens.find_by_user_id( current_user.id ) %>
        <% if user_token %>
          token
          (<%= user_token.oauth2_token_hash['scope'] %>
           <%= user_token.oauth2_token_hash['bearer'] %>)
            <% if user_token.oauth2_expired? %>
              <div>
                Token has expired
                <%= link_to 'Refresh',
                            open_humans_tokens_path( :service_id => service.id ),
                            :class => 'btn btn-small',
                            :method => :post %>
              </div>
            <% else %>
              <div class="open-humans-token" data-token-id="<%= user_token.id %>">
                Token is current... loading your registered huIDs
              </div>
            <% end %>
        <% else %>
          <%= link_to 'Add Authorization',
                      open_humans_tokens_path( :service_id => service.id ),
                      :class => 'btn btn-small',
                      :method => :post %>
        <% end %>
      </li>
    <% end %>
  </ul>

<% end %>
